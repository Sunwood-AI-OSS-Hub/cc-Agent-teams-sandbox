# GitHub Actions Workflow for Auto Release Notes
# Generates release header image and updates release notes

name: Auto Release Notes

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  generate-release-assets:
    name: Generate Release Header and Notes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Extract release info
        id: release_info
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          REPO_NAME="${{ github.repository }}"
          REPO_NAME="${REPO_NAME##*/}"
          RELEASE_DATE=$(date -d "${{ github.event.release.published_at }}" "+%B %d, %Y" 2>/dev/null || date "+%B %d, %Y")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT

      - name: Generate release header SVG
        run: |
          mkdir -p assets
          python3 .github/scripts/generate-header.py \
            --version "${{ steps.release_info.outputs.version }}" \
            --repo "${{ steps.release_info.outputs.repo_name }}" \
            --subtitle "Release Notes" \
            --date "${{ steps.release_info.outputs.release_date }}" \
            --output "assets/release-header-${{ steps.release_info.outputs.version }}.svg"

      - name: Commit and push header SVG
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/
          git diff --staged --quiet || git commit -m "docs: add release header for v${{ steps.release_info.outputs.version }}"
          git push origin HEAD:main

      - name: Wait for asset to be available
        run: sleep 5

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          {
            echo "<div align=\"center\">"
            echo ""
            echo "![Release v${{ steps.release_info.outputs.version }}](https://raw.githubusercontent.com/${{ github.repository }}/main/assets/release-header-${{ steps.release_info.outputs.version }}.svg)"
            echo ""
            echo "</div>"
            echo ""
            echo "## Release Information"
            echo ""
            echo "- **Version:** v${{ steps.release_info.outputs.version }}"
            echo "- **Date:** ${{ steps.release_info.outputs.release_date }}"
            echo ""
            echo "---"
            echo ""
            echo "## What's Changed"
            echo ""
          } > release_notes.md
          
          if [ -n "$PREV_TAG" ]; then
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse >> release_notes.md
          else
            git log --pretty=format:"- %s (%h)" --reverse -10 >> release_notes.md
          fi

      - name: Update release notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit "${{ github.event.release.tag_name }}" \
            --notes-file release_notes.md
