name: Auto Release Notes

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  generate-release-assets:
    name: Generate Release Assets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install Pillow

      - name: Generate header image
        env:
          RELEASE_VERSION: ${{ github.event.release.tag_name }}
          OUTPUT_PATH: release-header.png
          THEME: default
        run: |
          python .github/scripts/generate-header.py "$RELEASE_VERSION" "$OUTPUT_PATH"

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ./release-header.png
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release with header image
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ github.event.release.id }}
          HEADER_URL: https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/release-header.png
        run: |
          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®å…ˆé ­ã«ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã‚’è¿½åŠ 
          RELEASE_BODY=$(jq -r '.body' <<< '${{ toJson(github.event.release) }}')

          # ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã‚’å«ã‚€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’ä½œæˆ
          NEW_BODY="![Release Header](${{ env.HEADER_URL }})

          ${RELEASE_BODY}"

          # GitHub APIã§ãƒªãƒªãƒ¼ã‚¹ã‚’æ›´æ–°
          curl -X PATCH \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/${{ env.RELEASE_ID }} \
            -d "{\"body\":$(echo "$NEW_BODY" | jq -Rs .)}"

      - name: Comment on release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release = context.payload.release;
            const comment = `---
            **ã«ã‚ƒã‚ã€œã€ãƒªãƒªãƒ¼ã‚¹ãŠã‚ã§ã¨ã†ã«ã‚ƒï¼** ğŸ±

            ã“ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã¯ Nyan Corporation ã®è‡ªå‹•ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸã«ã‚ƒã€‚
            ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã‚‚è‡ªå‹•ã§ä½œæˆã•ã‚Œã¦ã‚‹ã§ã—ã‚‡ï¼Ÿ ãˆã‚‰ã„ã§ã—ã‚‡ï¼Ÿ

            ## Release Info
            - **Version**: ${release.tag_name}
            - **Released**: ${new Date().toLocaleString('ja-JP')}

            ---

            *Generated by Nyan Corporation Auto Release System* ğŸ¾`;

            console.log('Release notes updated with header image!');
